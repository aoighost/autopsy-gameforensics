<project name="AutopsyTSKTargets">
    
    <!-- Need a way to specify TSK Debug versus Release -->
    <property name="TSK_BUILD_TYPE">Release</property>
    
    
    <target name="build-installer-windows" depends="init-advanced-installer"
            description="Makes an installer from the opened ZIP file">
        <antcall target="run-advanced-installer" /> 
        <!--<delete dir="${nbdist.dir}/${app.name}-installer"/>-->
        <delete dir="${nbdist.dir}/installer_${app.name}-cache"/>
        <move file="${nbdist.dir}/installer_${app.name}-SetupFiles/installer_${app.name}.msi" tofile="${nbdist.dir}/installer_${app.name}-${app.version}.msi" />
    </target>

    <target name="init-advanced-installer" depends="autoAIPath,inputAIPath"
        description="Find AdvancedInstaller executable.">
        <fail unless="ai-exe-path" message="Could not locate Advanced Installer."/>
        <!-- Copy the template file to add details to -->
        <copy file="${basedir}/installer_${app.name}/installer_${app.name}.aip" tofile="${nbdist.dir}/installer_${app.name}.aip" overwrite="true"/>
        <property name="inst-path" value="${nbdist.dir}\${app.name}-installer"/>
        <property name="aip-path" value="${nbdist.dir}\installer_${app.name}.aip"/>
        <echo message="${ai-exe-path}" /> 
    </target>
    
    <target name="autoAIPath" description="Attempt to find the AI path based on standard installation location">
        <property name="AI.path" value="C:\Program Files (x86)\Caphyon\Advanced Installer 10.3\bin\x86\AdvancedInstaller.com" />
        <available file="${AI.path}"
                    property="ai-exe-path"
                    value="${AI.path}"/>
        <echo message="${ai-exe-path}" /> 
    </target>
   
    <target name="inputAIPath" unless="ai-exe-path" description="Have the user input the path to the AI executable">
        <input addProperty="ai-exe-path"
            message="Enter the location of AdvancedInstaller.com"/>
    </target>

    <target name="run-advanced-installer" depends="add-ai-productinfo,add-ai-files,add-ai-shortcuts,add-ai-env">
        <!-- Leaving this commented out bit for documentation purposes. Not sure what its supposed to do. -->       
        <!-- Need to find a way to deal with beta version -->
        <!--<echo message="Setting ${app.name} version to ${app.version}..."/>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /SetVersion ${app.version}"/>
        </exec>--> 
       
        
        <!--<delete file="${aip-path}"/>-->
    </target>
   
    <target name="add-ai-productinfo" description="Add product information to the aip file">
        <scriptdef name="generateguid" language="javascript">
            <attribute name="property" />
            <![CDATA[
            importClass( java.util.UUID );
    
            project.setProperty( attributes.get( "property" ), UUID.randomUUID() );
            ]]>
        </scriptdef>
        <generateguid property="guid1" />
        <!-- automatically replace version name and productcode in the .aip file -->
        <echo>Product Code: ${guid1}</echo>
        <echo>Product Version: ${app.version}</echo>
        
        <!-- Edit the API file to update versions: manual approach allows us to use non-X.Y.Z versions -->
        <replaceregexp  file="${aip-path}"
                        match="ProductCode&quot; Value=&quot;(\d{4}+:.)\w{8}+-\w{4}+-\w{4}+-\w{4}+-\w{12}+"
                        replace="ProductCode&quot; Value=&quot;\1${guid1}" />
                        
        <replaceregexp  file="${aip-path}"
                        match="ProductVersion&quot; Value=&quot;\d+\.{1}\d+\.{1}\d+"
                        replace="ProductVersion&quot; Value=&quot;${app.version}" />   
    </target>
   
    <target name="add-ai-files" description="Add the files in the installation path to the installer file">
        <foreach target="add-file-or-dir" param="theFile" inheritall="true" inheritrefs="true">
            <path> 
                <fileset dir="${inst-path}">
                    <include name="*" /> 
                </fileset>
                <dirset dir="${inst-path}">
                    <include name="*"/> 
                </dirset>
            </path>
        </foreach>
    </target>

    <target name="add-file-or-dir" depends="is-file-or-folder">
        <echo message="${ai-exe-path}" /> 
        <echo message="Adding ${file-or-folder} to installer: ${theFile}"/>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /Add${file-or-folder} APPDIR ${theFile}" />
        </exec>
    </target>

    <target name="is-file-or-folder">
        <condition property="file-or-folder" value="File" else="Folder">
            <available file="${theFile}" type="file" />
        </condition>
    </target>

    <target name="add-ai-shortcuts" description="Add shortcuts to the aip file">
        <echo message="Adding desktop/menu shortcuts..."/>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /NewShortcut -name ${app.title} -dir DesktopFolder -target APPDIR\bin\${app.name}.exe -icon ${inst-path}\icon.ico"/>
        </exec>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /NewShortcut -name ${app.title} -dir SHORTCUTDIR -target APPDIR\bin\${app.name}.exe -icon ${inst-path}\icon.ico"/>
        </exec>
    </target>

    <!-- TODO: does this always need to be done, or just for 64 bit files? -->
    <target name="add-ai-env" description="Add the enviornment variables to the aip file">
        <echo message="Setting environment variables..."/>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /NewEnvironment -name GSTREAMER_PATH -value [APPDIR]gstreamer\bin -install_operation CreateUpdate -behavior Append -system_variable"/>
        </exec>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /NewEnvironment -name GSTREAMER_PATH -value [APPDIR]gstreamer\lib\gstreamer-0.10 -install_operation CreateUpdate -behavior Append -system_variable"/>
        </exec>
        <exec executable="${ai-exe-path}">
            <arg line="/edit ${aip-path} /NewEnvironment -name PATH -value %GSTREAMER_PATH% -install_operation CreateUpdate -behavior Append -system_variable"/>
        </exec>
        <exec executable="${ai-exe-path}">
            <arg line="/build ${aip-path}"/>
        </exec>
    </target>

</project>
